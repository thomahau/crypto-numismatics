"use strict";const COINMARKETCAP_ENDPOINT="https://api.coinmarketcap.com/v1/";let tickerData,availableCoins,globalPortfolioValue=0;function populateSearchOptions(){availableCoins=tickerData.map(t=>`${t.name} (${t.symbol})`),$(".coin-search").autocomplete({source:availableCoins})}function checkIfLoggedIn(){if(localStorage.getItem("token")&&localStorage.getItem("username")){const t=localStorage.getItem("username"),e=localStorage.getItem("currency");UI.renderLoggedInNav(t),getTickerData(e).then(t=>{tickerData=t,UI.renderPortfolio()}).catch(t=>console.error(t))}else $(".welcome-container, .stats-wrapper").attr("hidden",!1)}function getTickerData(t){const e=COINMARKETCAP_ENDPOINT+`ticker/?limit=0&convert=${t}`;return fetch(e).then(t=>{if(t.ok)return t.json();throw new Error("Network response was not ok.")})}function handleSignup(){$(".register-form").submit(function(t){t.preventDefault();const e={username:$("#register-username").val(),password:$("#register-password").val(),passwordconfirm:$("#register-password-confirm").val()};register(e).then(t=>{UI.renderSignupSuccessMsg(t.username),handleFirstLogin(e)}).catch(t=>{UI.renderSignupHelpMsg(t)})})}function register(t){let e;return fetch("users",{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}}).then(t=>(e=t).json()).then(t=>{if(e.ok)return t;throw`${t.reason}: ${t.location} ${t.message}`})}function handleFirstLogin(t){const e={username:t.username,password:t.password};$(".modal").on("click",".first-login",function(){login(e).then(t=>{localStorage.setItem("username",t.username),localStorage.setItem("token",t.authToken),localStorage.setItem("currency","USD"),$(".modal").attr("hidden",!0),checkIfLoggedIn()}).catch(t=>console.error(t))})}function handleLogin(){$(".login-form").submit(function(t){t.preventDefault(),login({username:$("#login-username").val(),password:$("#login-password").val()}).then(t=>{localStorage.getItem("currency");localStorage.setItem("username",t.username),localStorage.setItem("token",t.authToken),$(".modal").attr("hidden",!0),checkIfLoggedIn()}).catch(t=>{UI.renderLoginHelpMsg(t)})})}function login(t){return fetch("auth/login",{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}}).then(t=>{if(t.ok)return t.json();throw"ValidationError: Invalid username or password"})}function handleLogout(){$("header").on("click",".js-logout",function(){localStorage.removeItem("username"),localStorage.removeItem("token"),location.reload()})}function round(t,e=2){return Number(Math.round(t+"e"+e)+"e-"+e).toFixed(e).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function handleTableSorting(){$("main").on("click",".sortable-header",function(t){const e=$(this);sortTable(e.data("sort"),e)})}function sortTable(t,e){const n=$("table");let o,a=!0,r=0,l="desc";for(;a;){let i,s=n.find("tr");for(a=!1,i=1;i<s.length-1;i++){o=!1;let e=s[i].getElementsByTagName("td")[t],n=s[i+1].getElementsByTagName("td")[t],a=formatForSort(e.firstElementChild?e.firstElementChild.textContent:e.textContent),r=formatForSort(n.firstElementChild?n.firstElementChild.textContent:n.textContent);if("desc"===l){if(a<r){o=!0;break}}else if("asc"===l&&a>r){o=!0;break}}if(o){const t=getDirectionIcon(l);$(".direction-icon").remove(),e.append(t),s[i].parentNode.insertBefore(s[i+1],s[i]),a=!0,r++}else 0===r&&"desc"===l&&(l="asc",a=!0)}}function formatForSort(t){return/^-?\$?\d*,?\d*\.?\d+%?$/.test(t)?parseFloat(t.replace(/[\$€£,]/g,""),10):t.toLowerCase()}function getDirectionIcon(t){return`\n\t<span class="direction-icon">\n\t\t<i class="fas fa-caret-${"desc"===t?"down":"up"}"></i>\n\t</span>`}$(function(){checkIfLoggedIn(),UI.handleModals(),handleSignup(),handleLogin(),handleLogout(),UI.handleSettingsDropdown()});const HOLDINGS_URL="holdings",Holdings={get:function(){return fetch("holdings",{headers:_getAuthHeaders()}).then(t=>{if(t.ok)return t.json()})},add:function(t){return fetch("holdings",{method:"POST",headers:_getAuthHeaders(),body:JSON.stringify(t)}).then(t=>{if(t.ok)return t.json()})},update:function(t){return fetch(`holdings/${t.id}`,{method:"PUT",headers:_getAuthHeaders(),body:JSON.stringify(t)}).then(t=>{t.ok})},delete:function(t){return fetch(`holdings/${t}`,{method:"DELETE",headers:_getAuthHeaders()}).then(t=>{t.ok})},populate:function(t){const e=localStorage.getItem("currency").toLowerCase();let n=[];return t.forEach(t=>{const o=tickerData.filter(e=>e.symbol===t.symbol)[0],a={id:t.id,symbol:t.symbol,name:t.name,amount:t.amount,price:parseFloat(o[`price_${e}`]),value:t.amount*parseFloat(o[`price_${e}`]),percent_change_24h:parseFloat(o.percent_change_24h),percent_change_7d:parseFloat(o.percent_change_7d)};n.push(a)}),n},getTotals:function(t){const e=t.reduce((t,e)=>t+e.value,0),n=t.reduce((t,e)=>t+_getPastValue(e.value,e.percent_change_24h),0),o=e-n,a=100*(e/n-1),r=t.reduce((t,e)=>t+_getPastValue(e.value,e.percent_change_7d),0),l=e-r,i=100*(e/r-1),s=_getBTCValue(e);return globalPortfolioValue=e,{total:e,totalBTC:round(s,3),change24Hrs:round(o),change24HrsPct:round(a),change7Days:round(l),change7DaysPct:round(i)}}};function _getAuthHeaders(){return{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}}function _getPastValue(t,e){return t/(1+e/100)}function _getBTCValue(t){const e=localStorage.getItem("currency").toLowerCase();return t/tickerData.find(t=>"BTC"===t.symbol)[`price_${e}`]}const UI={handleModals:function(){$("body").click(function(t){$(t.target).hasClass("modal")&&$(".modal").attr("hidden",!0)}),$(".modal").on("click",".close, .cancel-edit-btn",function(){$(".modal").attr("hidden",!0)}),this.handleRegisterModal(),this.handleLoginModal(),this.handleEditPortfolioModal()},handleRegisterModal:function(){$(".js-register").click(function(){$(".js-register-modal").attr("hidden",!1)})},handleLoginModal:function(){$(".js-login").click(function(){$(".js-login-modal").attr("hidden",!1)})},renderSignupSuccessMsg:function(t){const e=_getSignupSuccessMsg(t);$(".register-modal-body").html(e)},renderSignupHelpMsg:function(t){const e=_getHelpMsg(t);$("#register-password, #register-password-confirm").val(""),$(".register-help").attr("hidden",!1).html(e)},renderLoginHelpMsg:function(t){const e=_getHelpMsg(t);$("#login-username, #login-password").val(""),$(".login-help").attr("hidden",!1).html(e)},renderLoggedInNav:function(t){const e=_getNavElements(t);$(".js-login, .js-register").remove(),$(".header-container").append(e)},renderSearchHelpMsg:function(t){$(".search-help").attr("hidden",!1).html(t)},handleSettingsDropdown:function(){$("main").on("click",".js-drop-btn",function(){$(".dropdown-content").toggleClass("show")}),$("body").click(function(t){$(t.target).parent().hasClass("js-drop-btn")||$(".dropdown-content").removeClass("show")})},renderPortfolio:function(){let t;$(".welcome-container, .search-help, .stats-wrapper").attr("hidden",!0),Holdings.get().then(t=>Holdings.populate(t.holdings)).then(e=>{const n=_getPortfolioHeader(t=e),o=_getPortfolioTable(t),a=_getPortfolioFooter(t);return Promise.all([n,o,a])}).then(e=>{const[n,o,a]=e;$(".portfolio-container").attr("hidden",!1).empty().append(n).append(o).append(a),t.length?(PieChart.render(t),$("#chart-container").attr("hidden",!1)):$("#chart-container").attr("hidden",!0),this.handleNewCoinSubmit(),this.handleAddPortfolioItemClick(),this.handleCancelAdditionBtn(t),this.handleDeletePortfolioItem(),this.handleEditCurrency(),handleTableSorting()})},handleAddPortfolioItemClick:function(t){$("main").on("click",".js-add-portfolio-item",function(){const t=_getNewItemForm();$(".portfolio-footer").remove(),$(".portfolio-container").append(t),populateSearchOptions()})},handleCancelAdditionBtn:function(t){$("main").on("click",".cancel-addition-btn",function(){const e=_getPortfolioFooter(t);$(".js-add-coin-form, .portfolio-footer").remove(),$(".portfolio-container").append(e)})},handleNewCoinSubmit:function(){$("main").on("submit",".js-add-coin-form",function(t){t.preventDefault();const e=$(".coin-amount").val(),n=$(".coin-search").val();_validateInput(n).then(t=>{const o=n.split("("),a={symbol:o[1].slice(0,-1),name:o[0].slice(0,-1),amount:parseFloat(e,10)};return Holdings.add(a)}).then(t=>{UI.renderPortfolio()}).catch(t=>{UI.renderSearchHelpMsg(t)})})},handleEditPortfolioModal:function(){$("main").on("click",".js-edit-portfolio",function(){Holdings.get().then(t=>_getEditPortfolioForm(t.holdings)).then(t=>{$(".edit-holdings-modal").attr("hidden",!1),$(".js-edit-form-container").html(t),UI.handleEditPortfolioSubmit()})})},handleEditPortfolioSubmit:function(){$(".modal").on("submit",".edit-portfolio-form",function(t){t.preventDefault();const e=[];$('.edit-portfolio-form input[type="number"]').each(function(){e.push({id:this.name,amount:parseFloat($(this).val(),10)})});const n=e.map(t=>0===t.amount?Holdings.delete(t.id):Holdings.update(t));Promise.all(n).then(t=>{UI.renderPortfolio(),$(".modal").attr("hidden",!0)}).catch(t=>console.error(t))})},handleDeletePortfolioItem:function(){$("body").on("click",".delete-holding",function(t){const e=$(this).data("coin");Holdings.delete(e).then(()=>{UI.renderPortfolio(),$(".modal").attr("hidden",!0)}).catch(t=>console.error(t))})},handleEditCurrency:function(){$("main").on("click",".js-edit-currency",function(){$(".currency-select").val(localStorage.getItem("currency")),$(".edit-currency-modal").attr("hidden",!1),UI.handleEditCurrencySubmit()})},handleEditCurrencySubmit:function(){$(".edit-currency-form").submit(function(t){t.preventDefault();const e=$(".currency-select").val();localStorage.setItem("currency",e),getTickerData(e).then(t=>{tickerData=t,UI.renderPortfolio(),$(".modal").attr("hidden",!0)}).catch(t=>console.error(t))})}};function _getSignupSuccessMsg(t){return`\n\t<p>Welcome aboard, ${t}! You may now log in.</p>\n\t<button class="button-primary first-login">Log in</button>`}function _getHelpMsg(t){return`\n\t<span class="loss">${t}</span>`}function _getNavElements(t){return`\n\t<a class="js-logout u-pull-right">\n\t\t<i class="fas fa-sign-out-alt"></i><span class="nav-text"> Log out</span>\n\t</a>\n\t<p class="u-pull-right li-space">\n\t\t${t}\n\t</p>`}function _getNewItemForm(){return'\n\t<form class="js-add-coin-form">\n\t\t<div class="row portfolio-footer text-left darkest">\n\t\t\t<div class="six columns">\n\t\t\t\t<input type="search" class="coin-search" placeholder="Coin name" required />\n\t\t\t\t<input type="number" class="coin-amount" placeholder="Amount" min="0" step="any" required />\n\t\t\t\t<p class="search-help" aria-live="assertive" hidden></p>\n\t\t\t</div>\n\t\t\t<div class="four columns">\n\t\t\t\t<button type="submit" class="button-primary">Add coin</button>\n\t\t\t\t<a class="button cancel-addition-btn" role="button">Cancel</a>\n\t\t\t</div>\n\t\t</div>\n\t</form>'}function _getPortfolioHeader(t){const e=_getCurrencySymbol();let n="<p>Your portfolio is currently empty.</p>",o={total:0,totalBTC:0};return t.length&&(o=Holdings.getTotals(t),t.map(t=>t.allocation=100/o.total*t.value),o.total=round(o.total),n=_getPortfolioPerformance(o,e)),`\n\t\t<div class="row darkest">\n\t\t\t<ul class="nav-list portfolio-header">\n\t\t\t\t<li class="u-pull-right">\n\t\t\t\t\t<a class="portfolio-link share-portfolio disabled">\n\t\t\t\t\t\t<i class="fas fa-share-square"></i><span> Share</span>\n\t\t\t\t\t</a>\n\t\t\t\t</li>\n\t\t\t\t<li class="u-pull-right li-space">\n\t\t\t\t\t<div class="dropdown">\n\t\t\t\t\t\t<a class="portfolio-link portfolio-settings js-drop-btn">\n\t\t\t\t\t\t\t<i class="fas fa-cog"></i><span> Settings</span>\n\t\t\t\t\t\t</a>\n\t\t\t\t\t\t<div class="dropdown-content">\n\t\t\t\t\t\t\t<a class="js-edit-portfolio">Edit holdings</a>\n\t\t\t\t\t\t\t<a class="js-add-portfolio-item">Add holding</a>\n\t\t\t\t\t\t\t<a class="js-edit-currency">Edit currency</a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</li>\n\t\t\t</ul>\n\t\t</div>\n\t\t<div class="row darker portfolio-overview">\n\t\t\t<div class="three columns text-left">\n\t\t\t\t<strong>PORTFOLIO VALUE</strong>\n\t\t\t\t<p class="large-text">${e}${o.total} <small>(₿${o.totalBTC})</small></p>\n\t\t\t</div>\n\t\t\t<div class="five columns text-left">\n\t\t\t\t${n}\n\t\t\t</div>\n\t\t\t<div class="three columns chart-container u-full-width">\n\t\t\t\t<canvas id="allocation-chart" hidden></canvas>\n\t\t\t</div>\n\t\t</div>`}function _getPortfolioPerformance(t,e){const n=t.change24HrsPct>0?"gain":"loss",o=t.change7DaysPct>0?"gain":"loss";return`\n\t<strong>24 HOURS</strong>\n\t<p class="${n} large-text">${e}${t.change24Hrs} <small>(${t.change24HrsPct}%)</small></p>\n\t<strong>7 DAYS</strong>\n\t<p class="${o} large-text">${e}${t.change7Days} <small>(${t.change7DaysPct}%)</small></p>`}function _getPortfolioTable(t){const e=_getCurrencySymbol();let n="";return t.length&&t.forEach(t=>{const o=t.percent_change_24h>0?"gain":"loss",a=t.percent_change_7d>0?"gain":"loss",r=round(t.price),l=round(t.value),i=round(t.allocation);n+=`\n\t\t<tr>\n\t\t<td data-label="&nbsp;&nbsp;&nbsp;&nbsp;Coin"><span class="leftmost-cell">${t.name}</span></td>\n\t\t<td data-label="Price">${e}${r}</td>\n\t\t<td class="${o}" data-label="24 hrs">${t.percent_change_24h}%</td>\n\t\t<td class="${a}" data-label="7 days">${t.percent_change_7d}%</td>\n\t\t<td data-label="Amount">${t.amount}</td>\n\t\t<td data-label="Value">${e}${l}</td>\n\t\t<td data-label="Allocation">${i}%</td>\n\t\t<td data-label="Delete"><a class="portfolio-link delete-holding rightmost-cell" data-coin="${t.id}">x</a></td>\n\t\t</tr>`}),`\n\t\t<table class="u-full-width">\n\t\t  <thead class="darkest">\n\t\t    <tr>\n\t\t      <th>\n\t\t      \t<a class="sortable-header leftmost-cell" data-sort="0">Name</a>\n\t\t      </th>\n\t\t      <th>\n\t\t      \t<a class="sortable-header" data-sort="1">Price</a>\n\t\t      </th>\n\t\t      <th>\n\t\t      \t<a class="sortable-header" data-sort="2">24 hrs</a>\n\t\t      </th>\n\t\t      <th>\n\t\t      \t<a class="sortable-header" data-sort="3">7 days</a>\n\t\t      </th>\n\t\t      <th>\n\t\t      \t<a class="sortable-header" data-sort="4">Amount</a>\n\t\t      </th>\n\t\t      <th>\n\t\t      \t<a class="sortable-header" data-sort="5">Value</a>\n\t\t      </th>\n\t\t      <th>\n\t\t      \t<a class="sortable-header" data-sort="6">Allocation</a>\n\t\t      </th>\n\t\t      <th></th>\n\t\t    </tr>\n\t\t  </thead>\n\t\t  <tbody class="darker">\n\t\t\t${n}\n\t\t  </tbody>\n\t\t </table>`}function _getPortfolioFooter(t){return t.length?'\n\t\t<div class="row portfolio-footer darkest">\n\t\t\t<ul class="nav-list portfolio-footer-menu">\n\t\t\t\t<li class="u-pull-left li-space">\n\t\t\t\t\t<a class="portfolio-link js-add-portfolio-item">\n\t\t\t\t\t\t<i class="fas fa-plus"></i> Add\n\t\t\t\t\t</a>\n\t\t\t\t</li>\n\t\t\t\t<li class="u-pull-left">\n\t\t\t\t\t<a class="portfolio-link js-edit-portfolio">\n\t\t\t\t\t\t<i class="fas fa-edit"></i> Edit\n\t\t\t\t\t</a>\n\t\t\t\t</li>\n\t\t\t</ul>\n\t\t</div>':'\n\t\t<div class="row portfolio-footer darkest">\n\t\t\t<button class="button-primary u-pull-left js-add-portfolio-item start-btn">Get started</button>\n\t\t</div>'}function _getEditPortfolioForm(t){let e="";return t.forEach(t=>{e+=`\n\t\t<div class="row">\n\t\t\t<div class="three columns">\n\t\t\t\t<label for="${t.id}">${t.name}</label>\n\t\t\t</div>\n\t\t\t<div class="nine columns">\n\t\t\t\t<input type="number" name="${t.id}" value=${t.amount} min="0" step="any" />\n\t\t\t\t<a class="button delete-holding" role="button" data-coin="${t.id}">Delete</a>\n\t\t\t</div>\n\t\t</div>`}),`\n\t<form class="edit-portfolio-form">\n\t  ${e}\n\t  <div class="row">\n\t\t<button type="submit" class="button-primary">Update</button>\n\t\t<a class="button cancel-edit-btn" role="button">Cancel</a>\n\t</div>`}function _getCurrencySymbol(){const t=localStorage.getItem("currency");return"USD"===t?"$":"EUR"===t?"€":"GBP"===t?"£":void 0}function _validateInput(t){return new Promise((e,n)=>{let o=!1;for(let n=0;n<availableCoins.length&&!o;n++)if(t===availableCoins[n])return o=!0,$(".search-help").attr("hidden",!0).empty(),$(".coin-amount, .coin-search").val(""),e(o);setTimeout(()=>n("Invalid input"),250)})}const COLORS=["#4D4D4D","#5DA5DA","#FAA43A","#60BD68","#F17CB0","#B2912F","#B276B2","#DECF3F","#F15854","#072A49","#108A9F","#431833"],PieChart={render:function(t){const e=t.sort((t,e)=>e.allocation-t.allocation),n=document.getElementById("allocation-chart");new Chart(n,{type:"pie",data:{labels:_getChartLabels(e),datasets:[{label:"Holdings",data:_getChartData(e),backgroundColor:COLORS,borderColor:"#fff",borderWidth:1}]},options:{legend:{display:!1},animation:{duration:0},tooltips:{callbacks:{label:function(t,e){return e.labels[t.index]+": "+round(e.datasets[t.datasetIndex].data[t.index])+"%"}}}}})}};function _getChartLabels(t){return t.map(t=>t.name)}function _getChartData(t){return t.map(t=>t.allocation)}